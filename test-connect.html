<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¿æ¥æœåŠ¡å™¨æµ‹è¯•</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
    button { padding: 1rem 2rem; font-size: 1rem; cursor: pointer; margin: 0.5rem; }
    .success { background: #22c55e; color: white; border: none; border-radius: 8px; }
    .test { background: #3b82f6; color: white; border: none; border-radius: 8px; }
    pre { background: #f3f4f6; padding: 1rem; border-radius: 8px; overflow-x: auto; }
    .status { padding: 1rem; margin: 1rem 0; border-radius: 8px; }
    .status.ok { background: #dcfce7; border: 1px solid #22c55e; }
    .status.error { background: #fee2e2; border: 1px solid #ef4444; }
  </style>
</head>
<body>
  <h1>ğŸ”— è¿æ¥æœåŠ¡å™¨åŠŸèƒ½æµ‹è¯•</h1>
  
  <div id="status"></div>
  
  <h2>æµ‹è¯•æ­¥éª¤</h2>
  <ol>
    <li><button id="btnConnectServer" class="test">ğŸ”— ç‚¹å‡»æµ‹è¯•"è¿æ¥æœåŠ¡å™¨"æŒ‰é’®</button></li>
    <li><button id="btnTestAPI" class="test">ğŸ§ª æµ‹è¯•åç«¯ API è¿é€šæ€§</button></li>
    <li><button id="btnCheckStorage" class="test">ğŸ“¦ æ£€æŸ¥ localStorage é…ç½®</button></li>
    <li><button id="btnSubmitTest" class="success">âœ… æäº¤æµ‹è¯•ç¬”è®°åˆ°æœåŠ¡å™¨</button></li>
  </ol>
  
  <h2>æ—¥å¿—è¾“å‡º</h2>
  <pre id="log"></pre>
  
  <script>
    const log = document.getElementById('log');
    const status = document.getElementById('status');
    
    function addLog(msg) {
      const timestamp = new Date().toLocaleTimeString();
      log.textContent += `[${timestamp}] ${msg}\n`;
      log.scrollTop = log.scrollHeight;
    }
    
    function showStatus(msg, isOk) {
      status.className = `status ${isOk ? 'ok' : 'error'}`;
      status.textContent = msg;
    }
    
    // æµ‹è¯• 1: è¿æ¥æœåŠ¡å™¨æŒ‰é’®ï¼ˆæ¨¡æ‹Ÿå®é™…åŠŸèƒ½ï¼‰
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'btnConnectServer') {
        addLog('âœ… æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘æˆåŠŸ');
        const serverBase = prompt('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€ï¼ˆä¾‹å¦‚ï¼šhttp://172.19.128.194:3000ï¼‰', 'http://172.19.128.194:3000');
        if (serverBase && serverBase.trim()) {
          localStorage.setItem('SERVER_BASE', serverBase.trim());
          localStorage.setItem('SERVER_MODE', '1');
          addLog(`âœ… å·²ä¿å­˜é…ç½®: ${serverBase.trim()}`);
          showStatus('âœ… æœåŠ¡å™¨é…ç½®æˆåŠŸï¼å¯ä»¥åˆ·æ–°é¡µé¢å¯ç”¨æœåŠ¡å™¨æ¨¡å¼', true);
        } else {
          addLog('âŒ ç”¨æˆ·å–æ¶ˆæˆ–è¾“å…¥ä¸ºç©º');
        }
      }
    });
    
    // æµ‹è¯• 2: API è¿é€šæ€§
    document.getElementById('btnTestAPI').addEventListener('click', async () => {
      addLog('å¼€å§‹æµ‹è¯•åç«¯ API...');
      const serverBase = localStorage.getItem('SERVER_BASE') || 'http://172.19.128.194:3000';
      
      try {
        const response = await fetch(`${serverBase}/healthz`);
        if (response.ok) {
          const data = await response.json();
          addLog(`âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡: ${JSON.stringify(data)}`);
          showStatus('âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ', true);
        } else {
          addLog(`âŒ åç«¯è¿”å›é”™è¯¯: ${response.status}`);
          showStatus(`âŒ åç«¯è¿”å› HTTP ${response.status}`, false);
        }
      } catch (error) {
        addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);
        showStatus(`âŒ æ— æ³•è¿æ¥åˆ°åç«¯: ${error.message}`, false);
      }
    });
    
    // æµ‹è¯• 3: æ£€æŸ¥ localStorage
    document.getElementById('btnCheckStorage').addEventListener('click', () => {
      const serverBase = localStorage.getItem('SERVER_BASE');
      const serverMode = localStorage.getItem('SERVER_MODE');
      
      addLog('=== localStorage é…ç½® ===');
      addLog(`SERVER_BASE: ${serverBase || '(æœªè®¾ç½®)'}`);
      addLog(`SERVER_MODE: ${serverMode || '(æœªè®¾ç½®)'}`);
      
      if (serverBase && serverMode === '1') {
        showStatus('âœ… æœåŠ¡å™¨æ¨¡å¼å·²å¯ç”¨', true);
      } else {
        showStatus('âš ï¸ æœåŠ¡å™¨æ¨¡å¼æœªå¯ç”¨ï¼Œè¯·å…ˆç‚¹å‡»"è¿æ¥æœåŠ¡å™¨"æŒ‰é’®é…ç½®', false);
      }
    });
    
    // æµ‹è¯• 4: æäº¤æµ‹è¯•ç¬”è®°
    document.getElementById('btnSubmitTest').addEventListener('click', async () => {
      const serverBase = localStorage.getItem('SERVER_BASE') || 'http://172.19.128.194:3000';
      const serverMode = localStorage.getItem('SERVER_MODE');
      
      if (serverMode !== '1') {
        showStatus('âŒ è¯·å…ˆå¯ç”¨æœåŠ¡å™¨æ¨¡å¼', false);
        addLog('âŒ æœåŠ¡å™¨æ¨¡å¼æœªå¯ç”¨ï¼Œè¯·å…ˆé…ç½®');
        return;
      }
      
      addLog('å¼€å§‹æäº¤æµ‹è¯•ç¬”è®°...');
      
      const testNote = {
        topic_id: 'test-from-debug-page',
        final_md: `# æµ‹è¯•ç¬”è®°\n\nè¿™æ˜¯ä»è°ƒè¯•é¡µé¢æäº¤çš„æµ‹è¯•ç¬”è®°ã€‚\n\næ—¶é—´: ${new Date().toLocaleString()}\n\nåŠŸèƒ½éªŒè¯:\n- âœ… æŒ‰é’®ç‚¹å‡»äº‹ä»¶\n- âœ… localStorage é…ç½®\n- âœ… API è¿é€šæ€§\n- âœ… æ•°æ®æäº¤`,
        mode: 'note',
        team_config_path: null,
        policy: {
          index_vector: 0,
          index_graphrag: 0,
          index_table: 0
        }
      };
      
      try {
        const response = await fetch(`${serverBase}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testNote)
        });
        
        if (response.ok) {
          const result = await response.json();
          addLog(`âœ… æäº¤æˆåŠŸï¼`);
          addLog(`note_id: ${result.note_id}`);
          addLog(`db_status: ${result.db_status}`);
          showStatus(`âœ… æµ‹è¯•ç¬”è®°å·²æˆåŠŸå†™å…¥æœåŠ¡å™¨ï¼note_id: ${result.note_id}`, true);
        } else {
          addLog(`âŒ æäº¤å¤±è´¥: HTTP ${response.status}`);
          showStatus(`âŒ æäº¤å¤±è´¥: HTTP ${response.status}`, false);
        }
      } catch (error) {
        addLog(`âŒ æäº¤å‡ºé”™: ${error.message}`);
        showStatus(`âŒ æäº¤å‡ºé”™: ${error.message}`, false);
      }
    });
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥é…ç½®
    window.addEventListener('load', () => {
      addLog('=== è°ƒè¯•é¡µé¢å·²åŠ è½½ ===');
      addLog('é¡µé¢ URL: ' + location.href);
      
      const serverBase = localStorage.getItem('SERVER_BASE');
      const serverMode = localStorage.getItem('SERVER_MODE');
      
      if (serverBase && serverMode === '1') {
        addLog(`âœ… æœåŠ¡å™¨æ¨¡å¼å·²å¯ç”¨: ${serverBase}`);
        showStatus('âœ… æœåŠ¡å™¨æ¨¡å¼å·²å¯ç”¨ï¼Œå¯ä»¥ç›´æ¥æµ‹è¯•', true);
      } else {
        addLog('âš ï¸ æœåŠ¡å™¨æ¨¡å¼æœªå¯ç”¨ï¼Œè¯·å…ˆç‚¹å‡»"è¿æ¥æœåŠ¡å™¨"æŒ‰é’®é…ç½®');
        showStatus('âš ï¸ è¯·å…ˆç‚¹å‡»"è¿æ¥æœåŠ¡å™¨"æŒ‰é’®é…ç½®', false);
      }
    });
  </script>
</body>
</html>
